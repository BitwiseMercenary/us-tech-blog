<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"><meta name="author" content="OpenTable"><link rel="icon" href="/favicon.png"><title>OpenTable Tech UK Blog</title><meta name="description"><link rel="alternate" type="application/rss+xml" title="OpenTable Tech UK Blog" href="/atom.xml"><link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="stylesheet" href="/css/bootstrap.min.css"><link rel="stylesheet" href="/css/main.css"><script src="//fonts.otstatic.com/zys4lfz.js"></script><link rel="stylesheet" href="/css/highlight.css">
</head><body><nav class="navbar navbar-default navbar-fixed-top navbar-custom"><div class="container-fluid"><div class="navbar-header"><button type="button" data-toggle="collapse" data-target="#main-navbar" class="navbar-toggle"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a href="/" class="navbar-brand">OpenTable Tech UK Blog</a></div><div id="main-navbar" class="collapse navbar-collapse"><ul class="nav navbar-nav navbar-right"><li><a href="/about/">About</a></li><li><a href="/archives/">Archive</a></li><li><a href="/blog/authors/">Authors</a></li></ul></div><div class="avatar-container"><div class="avatar-img-border"><a href="/"><img src="/opentable.png" class="avatar-img"></a></div></div></div></nav><div id="header-big-imgs" data-num-img='3' data-img-src-1="/bigimgs/building.jpg" data-img-desc-1="Alphabeta Building" data-img-src-2="/bigimgs/kitchen.jpg" data-img-desc-2="OpenTable London office" data-img-src-3="/bigimgs/office.jpg" data-img-desc-3="OpenTable Engineers"></div><header class="header-section has-img"><div class="intro-header big-img"><div class="container"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class="page-heading"><h1>OpenTable Tech UK Blog</h1><hr class="small"><span class="page-subheading">The technology blog for OpenTable UK.</span></div></div></div></div><span class="img-desc"></span></div></header><div role="main" class="container"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class="posts-list"><article class="post-preview"><a href="/blog/2014/02/06/20-percent-time/"><h2 class="post-title">20% time: Why, as a manager, you should love your engineers to be doing it</h2></a><p class="post-meta">Posted on 6 February 2014 · <a href="/blog/categories/Leadership/" class="tag post-meta">Leadership</a></p><div class="post-entry"><p>We allow all our UK based developers to have some time to explore new technologies, try out prototypes and clean-up things that escape the day-to-day process. Two days out of ten, seems a lot doesn’t it?</p>
<h2 id="How-we-started"><a href="#How-we-started" class="headerlink" title="How we started"></a>How we started</h2><p>We started doing our 20% time when we had two week sprints with a release each sprint. We actually had three days of testing, small bug fixing and signing things off. We didn’t like starting our new stories for the next sprint as our QAs got behind and never really caught up. We decided to use this time more for clean-up but also for prototyping or trying something out. We had read of other companies doing something similar so were excited to give it a go. </p>
<p>One of the first times we did this we actually decided we wanted to automate all the testing of one of our systems, so that our QAs weren’t bogged down for those three days. In our first 20% time, we got most of the team on board as it was painful watching, let alone doing manual testing and we wanted faster feedback on our changes.</p>
<p>We got a lot of the system in a state we could test it. We basically wrote a lot of a page object model and a few features to talk to it. The next 20% time it needed cleaning up, the next we had a lot under test. With a bit of work the three day test cycle was down to about one day. This would never have happened if we were trying in normal sprint time. Major win number one and something no business owner had had to wrestle against other priorities.</p>
<p>After this instance we have had numerous similar examples, albeit on a smaller scale, where each team has been able to try things out, with no consequence in the event of failure, and achieved great prototypes. Much of our new architecture has been tested out in these sessions, new technologies, new approaches, can people work together?</p>
<h2 id="Failures-not-so-bad-after-all"><a href="#Failures-not-so-bad-after-all" class="headerlink" title="Failures, not so bad after all"></a>Failures, not so bad after all</h2><p>Of course, we have had many failures, but maybe even that helps, we won’t waste our proper sprint time. Some people ask me about rules when I talk about this. I think the key for me is that the engineers are truly given freedom to explore. If on the face of things something they are doing is completely away from what you are doing then it might seem a bit strange.</p>
<p>But what if they are looking to try something new and would have left your company to do so? What if they think it might be a solution but don’t know how to say? What if they can use it in nine months on an urgent project? All these things can and have happened.</p>
<h2 id="Fear-as-always-is-detrimental"><a href="#Fear-as-always-is-detrimental" class="headerlink" title="Fear, as always, is detrimental"></a>Fear, as always, is detrimental</h2></div><a href="/blog/2014/02/06/20-percent-time/" class="post-read-more">[Read More]</a></article><article class="post-preview"><a href="/blog/2014/02/03/coaching-style-over-substance/"><h2 class="post-title">Coaching style over substance</h2></a><p class="post-meta">Posted on 3 February 2014 · <a href="/blog/categories/Leadership/" class="tag post-meta">Leadership</a> · <a href="/blog/categories/Coaching/" class="tag post-meta">Coaching</a></p><div class="post-entry"><p>Have you ever been lucky enough to mentor someone who really got it? Maybe you’ve had the opposite experience and the session ended up being a failure for both of you?</p>
<p>We are fortunate enough to be in an industry that gives us the chance to coach others and have a direct influence on the learning of individuals around us. But how do we know when we’re doing it right, or more importantly what can we do when it starts to go wrong?</p>
<h2 id="Know-your-student-find-their-style"><a href="#Know-your-student-find-their-style" class="headerlink" title="Know your student, find their style"></a>Know your student, find their style</h2><p>Let’s start with the science behind how we learn.</p>
<p>The first recognised attempt to identify different approaches individuals use in order to learn was David Kolb with the book ‘<a href="http://www.amazon.co.uk/Experiential-Learning-Experience-Source-Development/dp/0132952610" target="_blank" rel="external">Experimental Learning</a>‘. Kolb suggested that humans have a range of learning techniques available to us and that we tend to lean on one learning style above all others.</p>
<p>In recent times his research has proved to be inaccurate - yes people have different learning styles, yes they  show an emphasis in one particular style but Kolb’s definition of separate styles was confused. </p>
<p>Enter <a href="http://en.wikipedia.org/wiki/Learning_styles#Peter_Honey_and_Alan_Mumford.27s_model" target="_blank" rel="external">Honey and Mumford and their 1999 adaptation on Kolb’s model</a>. They identified four distinct learning styles which have since grown to be the preferred assessment of human learning styles. </p>
<table style="font-size: 80%;margin-bottom:20px;"><br>    <tr><br>        <th style="padding:3px;"></th><br>        <th style="padding:3px;"><b>Description</b></th><br>        <th style="padding:3px;"><b>Learn best</b></th><br>        <th style="padding:3px;"><b>Learn worst</b></th><br>    </tr><br>    <tr style="background-color: #E5E5E5"><br>        <td style="padding:3px;vertical-align:top;"><b>Activists</b></td><br>        <td style="padding:3px;vertical-align:top;">Enjoy doing, tend to act first and think later. They like working with others but often hog the limelight.</td><br>        <td style="padding:3px;vertical-align:top;">When involved in new experiences, being thrown in the deep end and leading discussions.</td><br>        <td style="padding:3px;vertical-align:top;">Listening to long lectures, reading or writing on their own. Following precise information to the letter.</td><br>    </tr><br>    <tr><br>        <td style="padding:3px;vertical-align:top;"><b>Reflectors</b></td><br>        <td style="padding:3px;vertical-align:top;">Like to stand back, listen to others, look at the situation, gather data and carefully come to a conclusion.</td><br>        <td style="padding:3px;vertical-align:top;">Observing individuals or teams at work,  reviewing what has happened and what they have learned from it.</td><br>        <td style="padding:3px;vertical-align:top;">Acting as a leader in front of others, doing things without preparation, being rushed by deadlines.</td><br>    </tr><br>    <tr style="background-color: #E5E5E5"><br>        <td style="padding:3px;vertical-align:top;"><b>Theorists</b></td><br>        <td style="padding:3px;vertical-align:top;">Able to adapt and integrate observations into complex theories. Tend to be perfectionists. Detached and analytical rather than emotive.</td><br>        <td style="padding:3px;vertical-align:top;">When put into complex and structured situations having to apply their skill and knowledge. Have the chance to question and probe ideas.</td><br>        <td style="padding:3px;vertical-align:top;">With unstructured or poorly briefed activities. Will struggle in situations where emphasise is put on emotion or feelings.</td><br>    </tr><br>    <tr><br>        <td style="padding:3px;vertical-align:top;"><b>Pragmatists</b></td><br>        <td style="padding:3px;vertical-align:top;">Practical and down to earth. Keen to try things out they can be impatient especially with long discussions.</td><br>        <td style="padding:3px;vertical-align:top;">Respond well to demonstrations of techniques that show an obvious advantage.</td><br>        <td style="padding:3px;vertical-align:top;">Learning is all theory. No guidelines on how to accomplish activity. No apparent pay back.</td><br>    </tr><br></table>

<p>The important thing to remember is not all individuals can be pigeon-holed into one group. These characteristics are evident across all industries and teams; I can certainly see myself and others in this list. Can you?</p>
<p>Now we can silo and identify behaviour, we can look deeper into the flow of learning.</p></div><a href="/blog/2014/02/03/coaching-style-over-substance/" class="post-read-more">[Read More]</a></article><article class="post-preview"><a href="/blog/2013/11/22/beginning-a-journey-to-chatops-with-hubot/"><h2 class="post-title">Beginning a journey to chatops with Hubot</h2></a><p class="post-meta">Posted on 22 November 2013 · <a href="/blog/categories/Hubot/" class="tag post-meta">Hubot</a> · <a href="/blog/categories/Hipchat/" class="tag post-meta">Hipchat</a> · <a href="/blog/categories/Chatops/" class="tag post-meta">Chatops</a></p><div class="post-entry"><img src="/images/posts/hubot_pug_me.png" class="center">
<p>As a part of our 30% time a few of our team, <a href="https://twitter.com/ajroyle" target="_blank" rel="external">@ajroyle</a>, <a href="https://twitter.com/stack72" target="_blank" rel="external">@stack72</a> and I (<a href="https://twitter.com/ryantomlinson" target="_blank" rel="external">@ryantomlinson</a>) decided to get together and look at <a href="http://hubot.github.com/" target="_blank" rel="external">Hubot</a> with <a href="https://www.hipchat.com/" target="_blank" rel="external">Hipchat</a> integration. There are several weird and wonderful scripts that ship with Hubot (see above) but the core concept of driving tooling via chat is one that we see value in.</p>
<p>##What is Chatops?</p>
<p><a href="https://speakerdeck.com/jnewland/chatops-at-github" target="_blank" rel="external">Chatops</a> is a term coined by Github to describe their growing culture of “putting tools in the middle of the conversation”. But what does that exactly mean?</p>
<p>To move fast and maintain stability it’s important to have a culture of automation, measurement and sharing (<a href="http://www.opscode.com/blog/2010/07/16/what-devops-means-to-me/" target="_blank" rel="external">CAMS</a>). Tooling plays a key role in doing so and as your devops toolkit grows with the team there is an inherent learning and maintenance overhead. <a href="http://github.com/" target="_blank" rel="external">Github</a> made a move to centralise the conversation by driving everything they do into chat. By building tools and executing commands in a chat room that can be automated by a bot, communication doesn’t become an afterthought to operational processes but is core to how you operate. If I want to deploy code, I type a command into chat. If I want to take a server offline, I type a command into chat. If I want to merge a git pull request into master, I type in a command into chat, and so on. Communication is baked in.</p>
<p>##What is Hubot?</p>
<p>Hubot is a chat bot that sits in your chat room, listens for commands and executes them. It was written by Github in Coffeescript on Node.js and comes with a host of <a href="https://github.com/github/hubot-scripts/tree/master/src/scripts" target="_blank" rel="external">prewritten scripts</a> to get started with. Hubot also comes with a range of adaptors that allow it to plug-in to chat servers such as Campfire, IRC and Hipchat. We chose the latter.</p>
<p>##How do you get started?</p>
<p>I won’t re-write the readme because the getting started section <a href="https://github.com/github/hubot/tree/master/docs" target="_blank" rel="external">here</a> says it all. Using the node package manager it’s so easy to get up and running with <a href="https://github.com/blog/968-say-hello-to-hubot" target="_blank" rel="external">Hubot</a>. So many other people have documented this process that I won’t attempt to rewrite their <a href="http://net.tutsplus.com/tutorials/javascript-ajax/writing-hubot-plugins-with-coffeescript/" target="_blank" rel="external">good</a> <a href="https://github.com/blog/968-say-hello-to-hubot" target="_blank" rel="external">posts</a>.</p>
<p>##How we want to use it and our first scripts<br>Although the core scripts that shipped with Hubot are helpful…</p></div><a href="/blog/2013/11/22/beginning-a-journey-to-chatops-with-hubot/" class="post-read-more">[Read More]</a></article><article class="post-preview"><a href="/blog/2013/10/21/linking-to-your-app-in-windows-8/"><h2 class="post-title">Linking to your app in Windows 8</h2></a><p class="post-meta">Posted on 21 October 2013 · <a href="/blog/categories/OpenTable/" class="tag post-meta">OpenTable</a> · <a href="/blog/categories/Windows8/" class="tag post-meta">Windows8</a></p><div class="post-entry"><p>In an effort to raise the visibility of our excellent Windows 8 app we have recently connected <a href="http://www.opentable.com" target="_blank" rel="external">www.opentable.com</a> to the Windows Store.  This was simply a case of adding two lines of meta data to our site. Or it should have been &ndash; there were several gotchas along the way that are worth sharing.</p>
<p>##The code</p>
<p>The meta data that we added to the site are an <em>application ID</em>, and what Microsoft have termed the <em>Package Family name</em>.  Once you have these, add the following lines of code to your page &lt;head&gt;.</p>
<pre><code>&lt;meta name=&quot;msApplication-ID&quot; content=&quot;OpenTable.OpenTable&quot;/&gt; 
&lt;meta name=&quot;msApplication-PackageFamilyName&quot; content=&quot;OpenTable.OpenTable_r44en0zefym0a&quot;/&gt;
</code></pre><img src="/images/posts/get-app-for-this-site.png" class="right">
<p>This will enable the <strong>“Get app for this site”</strong> link when you are viewing your page in the full-screen Metro version of Internet Explorer (i.e. launched from the start screen); the desktop version of IE doesn’t have this capability.</p>
<p>There are <a href="http://msdn.microsoft.com/en-us/library/ie/hh781489%28v=vs.85%29.aspx#code-snippet-1" target="_blank" rel="external">three other optional meta values</a> that can also be used to control your link.</p>
<p>##Finding the values</p>
<p>There are at least two ways of finding the values. If you have your application code and Visual Studio 2012 (or later) then the values can be found in the <strong>package.appxmanifest</strong> file &ndash; open this in VS and it automatically launches the manifest designer view.  Select the Packaging tab and the “Package name” is the <em>ID</em>, and the <em>Package family name</em> is at the bottom of this screen.</p>
<img src="/images/posts/vs-screenshot.png" class="center"></div><a href="/blog/2013/10/21/linking-to-your-app-in-windows-8/" class="post-read-more">[Read More]</a></article><article class="post-preview"><a href="/blog/2013/09/25/resolving-domains-to-areas-in-asp-dot-net-mvc/"><h2 class="post-title">Resolving domains to areas in ASP.NET MVC</h2></a><p class="post-meta">Posted on 25 September 2013 · <a href="/blog/categories/ASP-NET-MVC/" class="tag post-meta">ASP.NET MVC</a> · <a href="/blog/categories/Routing/" class="tag post-meta">Routing</a> · <a href="/blog/categories/Hackiness/" class="tag post-meta">Hackiness</a></p><div class="post-entry"><p>When building a previous project, I created an ASP.NET MVC application that would allow subdomains to resolve to different areas of the project and thus show different views. I wanted to be able to extend this functionality. I wanted to allow different domains to point to different areas. This would allow me to deploy the application just once and then have different headers on the web server rather than regional variances. Whilst on a flight to San Francisco, I was able to hack together some code that allows just that. The details of that hackiness are below.</p>
<p>I started with a simple ASP.NET MVC application. I then created an area. The default area registration looks as follows:</p>
<pre><code>public class Domain1AreaRegistration: AreaRegistration   
{
    public override void RegisterArea(AreaRegistrationContext context)
    {
        context.MapRoute(
            &quot;Domain_1_default&quot;,
            &quot;Domain1/{controller}/{action}/{id}&quot;,
            new { controller = &quot;Home&quot;, action = &quot;Index&quot;, id = UrlParameter.Optional },
            new[] { &quot;WebApplication.Controllers&quot; }
        );
    }

    public override string AreaName
    {
        get { return &quot;Domain1&quot;; }
    }
}
</code></pre><p>The name of the folder in my project corresponds to the AreaName as above. I have approximately six areas in the application that relate to different views. Now is where the hacky magic happens. I build the routing for the application myself. In my global.asax.cs, I have the following declaration:</p>
<pre><code>protected void Application_Start()
{
    AreaRegistration.RegisterAllAreas();

    //this is done using my IoC container
    var routingEngine = new RoutingEngineFactory();
    routingEngine.RoutingRegistration(RouteTable.Routes);
}
</code></pre><p>This is the creation of my RoutingEngine. This class is responsible for taking each area in the system in turn and then creating the routes for my application based on these. I am sure you are asking why I am doing that? The answer is simply that I can use a combination of MapRoute and IRouteConstraints to build a sufficient route for the URLs I need to map. The code looks as follows:</p>
<pre><code>public void RoutingRegistration(RouteCollection routes)
{
    var areaNames = GetAllAreasRegistered(routes);
    routes.IgnoreRoute(&quot;{resource}.axd/{*pathInfo}&quot;);
    routes.IgnoreRoute(&quot;{*favicon}&quot;, new { favicon = @&quot;(.*/)?favicon.ico(/.*)?&quot; });

    foreach (var area in areaNames.Select(Area.From))
    {
        RegisterDefaultRoute(area.Name, routes);
    }
}

private void RegisterDefaultRoute(string areaName, RouteCollection routes)
{
    var defaultRoute = routes.MapRoute(
            BuildRouteSegment(areaName, &quot;Default&quot;),
            &quot;{controller}/{action}/{id}&quot;,
            new { controller = &quot;Home&quot;, action = &quot;Index&quot;, id = UrlParameter.Optional },
            BuildUrlConstraint(areaName),
            new[] { DefaultControllerNameSpace }
            );
    defaultRoute.SetAreaDataTokens(areaName);
}
</code></pre><p>The code works in the following way:</p>
<p>Get a list of all the areas.<br>Add the Ignore routes as these are more specific and need to be at the top of the list.<br>To this list of areas, add a new area of name string.Empty. This will allow us to register the routes for the non area parts of the site. This is really hacky as denoted by the code above.<br>Foreach area in the list, register a route. This route has the same URL for all routes.<br>But how do we distinguish which of the routes match to a specific domain?</p>
<p>routes.MapRoute in MVC has a number of overloads. The overload we will be using has the following signature:</p></div><a href="/blog/2013/09/25/resolving-domains-to-areas-in-asp-dot-net-mvc/" class="post-read-more">[Read More]</a></article><article class="post-preview"><a href="/blog/2013/09/23/quick-look-at-rethinkdb/"><h2 class="post-title">Quick look at RethinkDB</h2></a><p class="post-meta">Posted on 23 September 2013 · <a href="/blog/categories/MongoDB/" class="tag post-meta">MongoDB</a> · <a href="/blog/categories/NoSQL/" class="tag post-meta">NoSQL</a> · <a href="/blog/categories/RethinkDB/" class="tag post-meta">RethinkDB</a></p><div class="post-entry"><p>Someone in the office mentioned <a href="http://www.rethinkdb.com" target="_blank" rel="external">RethinkDb</a> and I was impressed by the rhetoric on the site, so I decided to spend a couple of hours spiking one of our existing nodejs apps with RethinkDb. The app currently uses MongoDb so inevitably I’m comparing the two.</p>
<h1 id="Things-I-liked"><a href="#Things-I-liked" class="headerlink" title="Things I liked:"></a>Things I liked:</h1><p><strong>Nodejs Driver</strong></p>
<p>The api on the nodejs driver is pretty nice, it makes a concerted effort to reduce “pyramid code” by allowing you to build your query by method-chaining and then call a <code>.run()</code> extension to execute the query.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">r.db(&apos;Comics&apos;)</div><div class="line"> .table(&apos;Superheroes&apos;)</div><div class="line"> .getAll(&apos;Marvel&apos;, &#123;index: &apos;universe&apos;&#125;)</div><div class="line"> .filter(&#123; hasSidekick: true &#125;)</div><div class="line"> .run(connection, function(err, cursor)&#123;</div><div class="line">    cursor.toArray(function(err, items)&#123;</div><div class="line">        callback(items);</div><div class="line">    &#125;);</div><div class="line"> &#125;);</div></pre></td></tr></table></figure>
<p><strong>Interface</strong><br>The management interface is very good, incredibly friendly, and has guided access to things like sharding and replication settings (as well as the usual array of other things to tinker with).</p>
<p><strong>Sharding, Replication and Clustering</strong></p>
<p>It’s all there, up front in the web UI, written in plain English and with friendly guides to help. The health and performance monitoring is available up-front in clear and concise graphics.</p>
<p><strong>Writes are non-locking operations</strong></p>
<p>A major bugbear for us with mongoDb is that writes require a database-level lock. RethinkDb allows block-level locks for write operations, and furthermore, reads can still proceed while write locks are in effect. <a href="http://en.wikipedia.org/wiki/Multiversion_concurrency_control" target="_blank" rel="external">MVCC ftw!</a></p></div><a href="/blog/2013/09/23/quick-look-at-rethinkdb/" class="post-read-more">[Read More]</a></article><article class="post-preview"><a href="/blog/2013/09/11/counting-in-elastic-search/"><h2 class="post-title">Counting in ElasticSearch</h2></a><p class="post-meta">Posted on 11 September 2013 · <a href="/blog/categories/ElasticSearch/" class="tag post-meta">ElasticSearch</a> · <a href="/blog/categories/Count/" class="tag post-meta">Count</a> · <a href="/blog/categories/Search/" class="tag post-meta">Search</a> · <a href="/blog/categories/PlainElastic-Net/" class="tag post-meta">PlainElastic.Net</a></p><div class="post-entry"><blockquote>
<p>Counting is the religion of this generation it is its hope and its salvation.<br>Gertrude Stein</p>
</blockquote>
<p>In our NeverEnding quest to provide better experience to the users we utilise user behaviour logs to influence future results. One particular case is restaurant popularity, which is indicated by many factors, for example how often it is searched and viewed.</p>
<p>In this blog post we will look into multiple ways of counting documents in Elastic Search which is crucial for this kind of activity. All examples here are provided using Elastic Search HTTP interface and code examples implemented with <a href="https://github.com/Yegoroff/PlainElastic.Net" target="_blank" rel="external">PlainElastic.NET</a> are <a href="https://gist.github.com/gondar/6320578" target="_blank" rel="external">available here</a></p>
<p>Before we make a deep dive into Elastic Search Counting options let’s define our expectations:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">So that I can order restaurants by those that are most searched</div><div class="line">As a potential diner</div><div class="line">I want the most searched statistics from the logs to be part of the search database</div></pre></td></tr></table></figure></p>
<p>Okay, that’s not exactly how our story was defined but as we don’t want to discuss the whole search infrastructure here, let’s assume this is sufficient.</p>
<p>Because we are eager engineers, we will quickly build some mock data against which to test our assumptions. Our restaurant name search logs look something like this:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">	&quot;RestaurantId&quot; : 2,</div><div class="line">	&quot;RestaurantName&quot; : &quot;Restaurant Brian&quot;,</div><div class="line">	&quot;DateTime&quot; : &quot;2013-08-16T15:13:47.4833748+01:00&quot;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>So we will populate our mock database with appropriate commands and check that all is in place:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">curl http://localhost:9200/store/item/ -XPOST -d &apos;&#123;&quot;RestaurantId&quot;:2,&quot;RestaurantName&quot;:&quot;Restaurant Brian&quot;,&quot;DateTime&quot;:&quot;2013-08-16T15:13:47.4833748+01:00&quot;&#125;&apos;</div><div class="line">curl http://localhost:9200/store/item/ -XPOST -d &apos;&#123;&quot;RestaurantId&quot;:1,&quot;RestaurantName&quot;:&quot;Restaurant Cecil&quot;,&quot;DateTime&quot;:&quot;2013-08-16T15:13:47.4833748+01:00&quot;&#125;&apos;</div><div class="line">curl http://localhost:9200/store/item/ -XPOST -d &apos;&#123;&quot;RestaurantId&quot;:1,&quot;RestaurantName&quot;:&quot;Restaurant Cecil&quot;,&quot;DateTime&quot;:&quot;2013-08-16T15:13:47.4833748+01:00&quot;&#125;&apos;</div><div class="line">curl http://localhost:9200/store/item/_search?q=*\&amp;pretty</div></pre></td></tr></table></figure></p>
<p>Our expected output is a count of documents for each restaurant. For example:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">	&quot;Restaurant Brian&quot; : 1</div><div class="line">	&quot;Restaurant Cecil&quot; : 2</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>There are three ways this can be achieved in Elastic Search; using count API (which seems like the most obvious way), a search with type set to count, or using facets to generate counts of all objects grouped by given property. Let’s compare them:</p>
<h3 id="Count-API"><a href="#Count-API" class="headerlink" title="Count API"></a>Count API</h3></div><a href="/blog/2013/09/11/counting-in-elastic-search/" class="post-read-more">[Read More]</a></article><article class="post-preview"><a href="/blog/2013/08/16/grunt-plus-vagrant-equals-acceptance-test-heaven/"><h2 class="post-title">Grunt + Vagrant = Acceptance Test Heaven</h2></a><p class="post-meta">Posted on 16 August 2013 · <a href="/blog/categories/Acceptance-tests/" class="tag post-meta">Acceptance tests</a> · <a href="/blog/categories/Automation/" class="tag post-meta">Automation</a> · <a href="/blog/categories/Grunt/" class="tag post-meta">Grunt</a> · <a href="/blog/categories/Vagrant/" class="tag post-meta">Vagrant</a></p><div class="post-entry"><p>My continued love affair with Grunt reached a new high the other day, when I combined <a href="http://www.vagrantup.com" target="_blank" rel="external">Vagrant</a> with my <a href="/blog/2013/08/08/grunt-your-deployments-too/">Grunt deployment tasks</a> and test runners.</p>
<p>I’m not going to bang on about how great Vagrant is, because better people than me have already soliloquised at length on that subject. Let’s just take it as writ that <strong>Vagrant is awesome</strong>. </p>
<p>The objective is simple, we want to have a virtualised environment to run our acceptance tests against, that we can create and provision on demand, to ensure that our acceptance tests only deal with functional-correctness, not data- or environment-correctness.</p>
<p>I created a set of Grunt tasks which were able to do the following:</p>
<ul>
<li>Spin up an provision a Vagrant instance</li>
<li>Deploy the project code    </li>
<li>Start the server</li>
<li>Run the acceptance tests</li>
<li>Tear it all down</li>
</ul>
<p>All from a single command: <code>grunt acceptance</code></p>
<p>The price of this magic? About ten lines of Bash script, a six line Vagrantfile and some Grunt glue.</p>
<h2 id="Diving-in"><a href="#Diving-in" class="headerlink" title="Diving in"></a>Diving in</h2><p>Assuming you’ve got Vagrant installed, you can create a Vagrantfile in the root of your project, which looks like this:</p>
<pre><code>Vagrant.configure(&quot;2&quot;) do |config|
    config.vm.box = &quot;Ubuntu precise 64 VMWare&quot;
    config.vm.box_url = &quot;http://files.vagrantup.com/precise64_vmware.box&quot;
    config.vm.network :forwarded_port, guest: 3000, host: 3000
    config.vm.provision :shell, :path =&gt; &quot;setup/bootstrap.sh&quot;
end
</code></pre></div><a href="/blog/2013/08/16/grunt-plus-vagrant-equals-acceptance-test-heaven/" class="post-read-more">[Read More]</a></article><article class="post-preview"><a href="/blog/2013/08/08/grunt-your-deployments-too/"><h2 class="post-title">Grunt your deployments too</h2></a><p class="post-meta">Posted on 8 August 2013 · <a href="/blog/categories/JavaScript/" class="tag post-meta">JavaScript</a> · <a href="/blog/categories/Grunt/" class="tag post-meta">Grunt</a> · <a href="/blog/categories/Deployment/" class="tag post-meta">Deployment</a></p><div class="post-entry"><p>We’ve been using <a href="http://www.gruntjs.com" target="_blank" rel="external">Grunt</a> as a build tool for our nodejs apps, and it’s brilliant. It lints, it configures, it minifies, it tests and it packages.</p>
<p>As we move towards getting our first node app into production, we were looking at ways to deploy it. First we thought of <a href="http://www.capistranorb.com" target="_blank" rel="external">Capistrano</a>.</p>
<p><strong><em>Capistrano</em></strong> is a fully featured deployment framework written in ruby and levering rake style tasks. It’s extremely powerful and very robust, plus there is a <a href="https://github.com/loopj/capistrano-node-deploy" target="_blank" rel="external">gem for node deployments</a>. Alas, it was not to be. After half a day of tail chasing and hoop jumping, it occurred to me that there must be an easier way. Capistrano was encouraging me to make my project fit their template, rather than allowing me to configure the deployment to match my project. When I dug down into the Capistrano source, I found that it was just using ssh and sftp to run remote commands and copy files. But we can simplify this process.</p>
<p><strong><em>Grunt</em></strong> has been great so far, so I started looking at deploying directly through grunt. We would be deploying to Ubuntu server boxes, so the only tools necessary are ssh and sftp.</p>
<p>There are Grunt modules for nearly <a href="https://npmjs.org/search?q=grunt" target="_blank" rel="external">everything</a> (linting, minifying, testing, waiting, packaging, shell-exec’ing, tagging, etc.), and rather predictably, sshing (with sftp).</p>
<p><a href="https://github.com/andrewrjones/grunt-ssh" target="_blank" rel="external">Grunt-ssh</a> provides tasks for executing remote ssh commands, and for copying files using ssh. Let’s dive into some code.</p>
<p><strong><em>SSH commands</em></strong></p>
<p>This is going to go over some old ground (available on the Grunt-ssh <a href="https://github.com/andrewrjones/grunt-ssh" target="_blank" rel="external">readme</a>), but we can build up the commands pretty quick.</p>
<p>This is the basic config for executing ssh commands from your Gruntfile:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">module.exports = function(grunt) &#123;</div><div class="line">  	grunt.initConfig(&#123;</div><div class="line">    	sshexec: &#123;</div><div class="line">      uptime: &#123;</div><div class="line">        command: &quot;uptime&quot;,</div><div class="line">        options: &#123;</div><div class="line">          host: &quot;127.0.0.1&quot;,</div><div class="line">          port: 22</div><div class="line">          username: &quot;myuser&quot;,</div><div class="line">          password: &quot;mypass&quot;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;  </div><div class="line">  &#125;);</div><div class="line"></div><div class="line">  // Load the plugin that provides the &quot;sshexec&quot; task.</div><div class="line">  grunt.loadNpmTasks(&apos;grunt-ssh&apos;);</div><div class="line"></div><div class="line">  // Default task.</div><div class="line">  grunt.registerTask(&apos;default&apos;, [&apos;sshexec:uptime&apos;]);</div><div class="line"></div><div class="line">&#125;;</div></pre></td></tr></table></figure></div><a href="/blog/2013/08/08/grunt-your-deployments-too/" class="post-read-more">[Read More]</a></article><article class="post-preview"><a href="/blog/2013/08/07/mapreduce-in-mongodb/"><h2 class="post-title">MapReduce in MongoDB</h2></a><p class="post-meta">Posted on 7 August 2013 · <a href="/blog/categories/Innovation/" class="tag post-meta">Innovation</a> · <a href="/blog/categories/JavaScript/" class="tag post-meta">JavaScript</a> · <a href="/blog/categories/MapReduce/" class="tag post-meta">MapReduce</a> · <a href="/blog/categories/MongoDB/" class="tag post-meta">MongoDB</a></p><div class="post-entry"><p>One of the first things I took on when joining OpenTable was building a new endpoint in our reviews API to aggregate and summarise restaurant review data. Thankfully, at the time, all the data I needed was cached in memory so building the response object was a simple set of linq queries over the cached reviews.</p>
<h2 id="The-problem"><a href="#The-problem" class="headerlink" title="The problem"></a>The problem</h2><p>Over time the number of reviews grow, and grow, and grow!  In fact it is inevitable that, in time, it will reach a point where caching all this data in memory would be madness.  One option to mitigate this would be to limit the cache to a fixed date range but this won’t work in this instance because the summary logic supports custom date ranges.  Another option would be to pull the data from the persistence store each and every time it’s required however this would seriously impact load on the infrastructure and degrade performance of the API.</p>
<p>We like to be proactive at OpenTable, so during innovation time (yes! we get time to innovate on our development) I looked at finding an alternate solution that would meet the requirements of the logic and wouldn’t drastically increase load or degrade performance.</p>
<h2 id="The-solution"><a href="#The-solution" class="headerlink" title="The solution"></a>The solution</h2><p>MongoDB supports <a href="http://en.wikipedia.org/wiki/MapReduce" target="_blank" rel="external">MapReduce</a> which allows processing large volumes of data (Map), running arbitrary logic to summarise (Reduce) and producing some results.  In MongoDB the MapReduce functionality uses JavaScript functions to perform the map and reduce steps and the syntax is relatively simple to understand:-</p>
<pre><code>db.largeDataset.mapReduce(mapFunction, 
                          reduceFunction, 
                          { out: &quot;summary&quot; }
</code></pre><p>In the above example the largeDataset collection is mapped using the predefined mapFunction, the results are passed to the reduceFunction and the reduced data is finally stored in the summary collection. On top of this you can specify queries as well as a finalize function to “tweak” the reduce results.</p>
<p>Because map, reduce &amp; finalize are functions that only operate on their inputs the workload can be parallelized although the final results would be stored in one location.</p>
<h4 id="Map"><a href="#Map" class="headerlink" title="Map"></a>Map</h4></div><a href="/blog/2013/08/07/mapreduce-in-mongodb/" class="post-read-more">[Read More]</a></article></div><ul class="pager main-pager"><li class="previous"><a href="/page/4">← Newer Posts</a></li><li class="next"><a href="/page/6">Older Posts →</a></li></ul></div></div></div><footer><div class="container beautiful-jekyll-footer"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center footer-links"><li><a href="https://github.com/opentable" title="GitHub"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-stack-1x fa-inverse fa-github"></i></span></a></li><li><a href="https://twitter.com/opentabletechuk" title="Twitter"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-stack-1x fa-inverse fa-twitter"></i></span></a></li><li><a href="https://www.linkedin.com/company/12181" title="LinkedIn"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-stack-1x fa-inverse fa-linkedin"></i></span></a></li><li><a href="http://stackoverflow.com/jobs/companies/opentable" title="StackOverflow"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-stack-1x fa-inverse fa-stack-overflow"></i></span></a></li></ul><p class="copyright text-muted">© OpenTable • 2016 • <a href="mailto:undefined"></a>
</p><p class="theme-by text-muted">Theme by
<a href="https://github.com/twoyao/beautiful-hexo">beautiful-hexo</a></p></div></div></div></footer><script src="/js/jquery-1.11.2.min.js"></script><script src="/js/bootstrap.min.js"></script><script src="/js/main.js"></script><script src="/js/highlight.min.js"></script><script>hljs.initHighlightingOnLoad();</script><script>(function (i, s, o, g, r, a, m) {
    i['GoogleAnalyticsObject'] = r;
    i[r] = i[r] || function () {
                (i[r].q = i[r].q || []).push(arguments)
            }, i[r].l = 1 * new Date();
    a = s.createElement(o),
            m = s.getElementsByTagName(o)[0];
    a.async = 1;
    a.src = g;
    m.parentNode.insertBefore(a, m)
})(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');
ga('create', 'UA-2621903-16', 'auto');
ga('send', 'pageview');</script></body></html>